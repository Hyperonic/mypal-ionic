<ion-header>
    <ion-navbar color="primary">
        <ion-buttons left>
            <button ion-button (click)="close()" [hidden]="stateSuccess()">Cancel</button>
        </ion-buttons>
        <ion-title>
            {{title()}}
        </ion-title>
    </ion-navbar>
</ion-header>


<ion-content padding [hidden]="!stateForm()">
    <div class="note">
        Top ups online may take <span style="font-weight:600">up to 90 minutes to process</span>. If you plan to travel sooner, PTV recommends you top up at a myki machine, myki retail shop or ticket office.
    </div>

    <div class="loading" [hidden]="!loadingTopUp">
        <ion-spinner name="crescent"></ion-spinner>
        <div class="text">Loading top up</div>
    </div>

    <div [hidden]="loadingTopUp">
        <div *ngIf="isTopupMoney()">
            <form [formGroup]="formTopupMoney">
                <ul class="card-list">
                    <ion-item no-lines>
                        <ion-label>Top up amount ($)</ion-label>
                        <ion-input type="tel" formControlName="moneyAmount" [(ngModel)]="topupOptions.moneyAmount" clearOnEdit></ion-input>
                    </ion-item>
                </ul>
                <div class="error" *ngIf="formTopupMoney.controls.moneyAmount.touched">
                    <div *ngIf="formTopupMoney.controls.moneyAmount.hasError('invalidMoneyAmount')">
                        <ion-icon name="ios-alert-outline"></ion-icon> Invalid top up amount.</div>
                </div>
                <div class="note">
                    Minimum top up amount $10, maximum $250. <a href="https://www.ptv.vic.gov.au/tickets/myki/top-up-a-myki/myki-money/">Learn more about myki money.</a>
                </div>
            </form>
        </div>
        <div *ngIf="isTopupPass()">
            <form [formGroup]="formTopupPass">
                <ul class="card-list">
                    <ion-item no-lines>
                        <ion-label>Pass duration (days)</ion-label>
                        <ion-input type="tel" formControlName="passDuration" [(ngModel)]="topupOptions.passDuration" clearOnEdit></ion-input>
                    </ion-item>
                </ul>
                <div class="error" *ngIf="formTopupPass.controls.passDuration.touched">
                    <div *ngIf="formTopupPass.controls.passDuration.hasError('invalidPassDuration')">
                        <ion-icon name="ios-alert-outline"></ion-icon> Invalid pass duration.</div>
                </div>
                <div class="note">
                    Pass available in either 7 days or between 28-365 days. Remember you will need a positive myki money balance to activate a myki pass. <a href="https://www.ptv.vic.gov.au/tickets/myki/top-up-a-myki/myki-pass/">Learn more about myki pass</a>.
                </div>
                <ul class="card-list">
                    <ion-item no-lines>
                        <ion-label>From zone</ion-label>
                        <ion-select formControlName="zoneFrom" [(ngModel)]="topupOptions.zoneFrom">
                            <ion-option *ngFor="let zone of zoneSelect()" [value]="zone">Zone {{zone}}</ion-option>
                        </ion-select>
                    </ion-item>
                    <ion-item no-lines>
                        <ion-label>To zone</ion-label>
                        <ion-select formControlName="zoneTo" [(ngModel)]="topupOptions.zoneTo">
                            <ion-option *ngFor="let zone of zoneSelect()" [value]="zone">Zone {{zone}}</ion-option>
                        </ion-select>
                    </ion-item>
                </ul>
                <div class="error" *ngIf="formTopupPass.touched">
                    <div *ngIf="formTopupPass.hasError('invalidZones')">
                        <ion-icon name="ios-alert-outline"></ion-icon> Invalid zones. The "to" zone must be greater than "from"" zone.</div>
                    <div *ngIf="formTopupPass.hasError('zoneToInvalid')">
                        <ion-icon name="ios-alert-outline"></ion-icon> "To" zone must be at least zone 2.</div>
                </div>
                <div class="note">
                    Myki allows Zone 1 customers to travel in Zone 2 for free. <a href="https://ptv.vic.gov.au/tickets/zones/">Read about zones here</a>.
                </div>
            </form>
        </div>
        <button ion-button block (click)="order()" [disabled]="!canOrder()">Next</button>
    </div>
</ion-content>

<ion-content padding [hidden]="!statePay()">
    <div class="loading" [hidden]="!loadingPay">
        <ion-spinner name="crescent"></ion-spinner>
        <div class="text">Loading top up payment</div>
    </div>

    <div [hidden]="loadingPay">
        <ul class="card-list topup-summary">
            <ion-item no-lines>
                <div item-left>Myki card</div>
                <div item-right>{{mykiProvider.activeCard().idFormatted()}}</div>
            </ion-item>

            <ion-item no-lines>
              <div item-left>Top up</div>
                <div item-right>{{topupOrder.description}}</div>
            </ion-item>

            <ion-item no-lines>
                <div item-left><strong>Total</strong></div>
                <div item-right><strong>{{topupOrder.amount | currency:'USD':true}}</strong> <small *ngIf="topupOrder.gstAmount"><br>GST included: {{topupOrder.gstAmount | currency:'USD':true}}</small></div>
            </ion-item>
        </ul>
        <form [formGroup]="formTopupPayCC">
            <div class="note">
                Pay with credit card (Myki only accepts Mastercard and Visa). This app does not store any credit card details.
            </div>
            <ul class="card-list">
                <ion-item no-lines>
                    <ion-label fixed>Card</ion-label>
                    <ion-input class="ccNumber" type="tel" formControlName="card" [(ngModel)]="topupOptions.ccNumber" placeholder="•••• •••• •••• ••••"></ion-input>
                </ion-item>
                <ion-item no-lines>
                    <ion-label fixed>Expiry</ion-label>
                    <ion-input class="ccExpiry" type="tel" formControlName="expiry" [(ngModel)]="topupOptions.ccExpiry" placeholder="mm/yy"></ion-input>
                </ion-item>
                <ion-item no-lines>
                    <ion-label fixed>CVC</ion-label>
                    <ion-input class="ccCVC" type="tel" formControlName="cvc" [(ngModel)]="topupOptions.ccCVC" placeholder="•••"></ion-input>
                </ion-item>
            </ul>
            <div class="error" *ngIf="formTopupPayCC.controls.card.touched">
                <div *ngIf="formTopupPayCC.controls.card.hasError('invalidNumber')">
                    <ion-icon name="ios-alert-outline"></ion-icon> Invalid credit card number.</div>
                <div *ngIf="formTopupPayCC.hasError('invalidCardType')">
                    <ion-icon name="ios-alert-outline"></ion-icon> Invalid credit card type. Only Mastercard and Visa supported.</div>
            </div>
            <div class="error" *ngIf="formTopupPayCC.controls.expiry.touched">
                <div *ngIf="formTopupPayCC.controls.expiry.hasError('invalidExpiry')">
                    <ion-icon name="ios-alert-outline"></ion-icon> Invalid expiry.</div>
            </div>
            <div class="error" *ngIf="formTopupPayCC.controls.cvc.touched">
                <div *ngIf="formTopupPayCC.hasError('invalidCVC')">
                    <ion-icon name="ios-alert-outline"></ion-icon> Invalid CVC.</div>
            </div>
        </form>
        <form [formGroup]="formTopupPayReminder">
            <ul class="card-list">
                <ion-item no-lines>
                    <ion-label>Send receipt by</ion-label>
                    <ion-select formControlName="reminderType" [(ngModel)]="topupOptions.reminderType">
                        <ion-option [value]="0">Email</ion-option>
                        <ion-option [value]="1">Mobile</ion-option>
                        <ion-option [value]="2">None</ion-option>
                    </ion-select>
                </ion-item>
                <ion-item no-lines [hidden]="!isReminderEmail()">
                    <ion-label fixed>Email</ion-label>
                    <ion-input type="email" formControlName="reminderEmail" [(ngModel)]="topupOptions.reminderEmail" placeholder="john@doe.com"></ion-input>
                </ion-item>
                <ion-item no-lines [hidden]="!isReminderMobile()">
                    <ion-label fixed>Mobile</ion-label>
                    <ion-input type="phone" formControlName="reminderMobile" [(ngModel)]="topupOptions.reminderMobile" [required]="isReminderMobile()" placeholder="04xxxxxxxx"></ion-input>
                </ion-item>
            </ul>
            <div class="error" *ngIf="formTopupPayReminder.touched">
                <div *ngIf="formTopupPayReminder.hasError('emailRequired')">
                    <ion-icon name="ios-alert-outline"></ion-icon> Email address required.</div>
                <div *ngIf="formTopupPayReminder.controls.reminderEmail.errors?.pattern">
                    <ion-icon name="ios-alert-outline"></ion-icon> Valid email address required.</div>
                <div *ngIf="formTopupPayReminder.hasError('mobileRequired')">
                    <ion-icon name="ios-alert-outline"></ion-icon> Mobile phone number required.</div>
            </div>
        </form>
        <button ion-button block (click)="pay()" [disabled]="!canPay()">Pay</button>
    </div>
</ion-content>

<ion-content class="success" padding [hidden]="!stateSuccess()">
    <div class="message">
        <ion-icon name="checkmark-circle"></ion-icon>
        <h2>Top up confirmed</h2>
        <p>Myki card {{mykiProvider.activeCard().idFormatted()}} topped up with {{topupOrder.description}}. Credit card ending in {{topupOptions.ccNumberNoSpaces().slice(-4)}} has been charged {{topupOrder.amount | currency:'USD':true}}</p>
        <p>Top ups may take up to 90 minutes to be processed and will not immediately appear in the app. After it is processed it will be synced to your card the next time you touch on.</p>
        <button ion-button block color="brand-inverse" (click)="close()">Close</button>
    </div>
</ion-content>